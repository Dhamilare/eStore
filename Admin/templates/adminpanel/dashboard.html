{% extends 'adminpanel/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_head %}
    <style>
        .kpi-row .col {
            margin-bottom: 20px; /* Spacing between KPI cards */
        }
        .chart-container {
            height: 350px; /* Fixed height for charts to maintain consistency */
            width: 100%;
            display: flex; /* Use flexbox to center canvas */
            justify-content: center;
            align-items: center;
        }
        .chart-card canvas {
            max-height: 100%; /* Ensure canvas fits its container */
            max-width: 100%;
        }
        .kpi-card .fas {
            font-size: 1.8rem; /* Larger icon size */
            margin-bottom: 8px; /* Space between icon and text */
            opacity: 0.9;
        }
    </style>
{% endblock %}

{% block content %}
<h2 class="mb-4 text-center text-dark fw-bold">Analytics Dashboard</h2>

<div class="row kpi-row">
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card">
            <i class="fas fa-shopping-bag"></i>
            <h5>Total Orders</h5>
            <p>{{ kpis.total_orders|intcomma }}</p>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card">
            <i class="fas fa-dollar-sign"></i>
            <h5>Total Revenue</h5>
            <p>₦{{ kpis.total_revenue|floatformat:2|intcomma }}</p>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card" style="background: linear-gradient(135deg, #1abc9c, #16a085);"> {# Custom color gradient #}
            <i class="fas fa-users"></i>
            <h5>Total Customers</h5>
            <p>{{ kpis.total_customers|intcomma }}</p>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);"> {# Custom color gradient #}
            <i class="fas fa-cubes"></i>
            <h5>Products in Stock</h5>
            <p>{{ kpis.products_in_stock|intcomma }}</p>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card" style="background: linear-gradient(135deg, #3498db, #2980b9);"> {# Custom color gradient #}
            <i class="fas fa-calendar-day"></i>
            <h5>Orders Today</h5>
            <p>{{ kpis.orders_today|intcomma }}</p>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);"> {# Custom color gradient #}
            <i class="fas fa-money-bill-wave"></i>
            <h5>Revenue Today</h5>
            <p>₦{{ kpis.revenue_today|floatformat:2|intcomma }}</p>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);"> {# Custom color gradient #}
            <i class="fas fa-calendar-alt"></i>
            <h5>Orders This Month</h5>
            <p>{{ kpis.orders_this_month|intcomma }}</p>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card kpi-card" style="background: linear-gradient(135deg, #27ae60, #2ecc71);"> {# Custom color gradient #}
            <i class="fas fa-hand-holding-usd"></i>
            <h5>Revenue This Month</h5>
            <p>₦{{ kpis.revenue_this_month|floatformat:2|intcomma }}</p>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-lg-6 mb-4">
        <div class="card chart-card">
            <div class="card-header"><h4>Monthly Sales Trend</h4></div>
            <div class="card-body chart-container">
                <canvas id="monthlySalesChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card chart-card">
            <div class="card-header"><h4>Order Status Distribution</h4></div>
            <div class="card-body chart-container">
                <canvas id="orderStatusChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-12 mb-4">
        <div class="card chart-card">
            <div class="card-header"><h4>Top 5 Best-Selling Products (by Quantity)</h4></div>
            <div class="card-body chart-container">
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Retrieve chart data passed from the Django view
        // Using json_script filter to safely pass JSON data
        const chartDataElement = document.getElementById('chart-data');
        if (!chartDataElement) {
            console.error("Chart data element not found. Make sure 'chart_data' is passed to the template context and rendered with |json_script.");
            return;
        }
        // CORRECTED: Parse the text content of the script tag, not the tag itself.
        const chartData = JSON.parse(chartDataElement.textContent);

        // Chart.js Configuration
        // Monthly Sales Trend Chart
        const ctxSales = document.getElementById('monthlySalesChart').getContext('2d');
        new Chart(ctxSales, {
            type: 'line',
            data: {
                labels: chartData.monthly_sales_labels,
                datasets: [{
                    label: 'Total Sales (₦)',
                    data: chartData.monthly_sales_data,
                    borderColor: '#6C63FF', /* Primary color from custom CSS */
                    backgroundColor: 'rgba(108, 99, 255, 0.2)', /* Lighter fill for area under line */
                    tension: 0.3, /* Smooth line effect */
                    fill: true, /* Fill area under the line */
                    pointBackgroundColor: '#6C63FF',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, /* Allow manual control of aspect ratio */
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Revenue (₦)', color: '#555' },
                        grid: { color: 'rgba(0,0,0,0.08)', drawBorder: false }, /* Light grid lines */
                        ticks: {
                            callback: function(value) {
                                return '₦' + value.toLocaleString(); /* Format Y-axis labels as currency */
                            },
                            color: '#555'
                        }
                    },
                    x: {
                        grid: { display: false }, /* No vertical grid lines */
                        ticks: { color: '#555' }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#333'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '₦' + context.parsed.y.toLocaleString();
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Order Status Distribution Chart (Doughnut Chart)
        const ctxStatus = document.getElementById('orderStatusChart').getContext('2d');
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: chartData.order_status_labels,
                datasets: [{
                    data: chartData.order_status_counts,
                    backgroundColor: [
                        '#f39c12', /* Pending - Orange */
                        '#3498db', /* Processing - Blue */
                        '#2ecc71', /* Shipped - Green */
                        '#9b59b6', /* Delivered - Purple */
                        '#e74c3c'  /* Cancelled - Red */
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right', /* Legend on the right side */
                        labels: {
                            color: '#333'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: (context) => {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed + ' orders';
                                }
                                return label;
                            }
                        }
                    }
                },
                cutout: '70%', /* Thicker doughnut */
            }
        });

        // Top 5 Best-Selling Products Chart (Horizontal Bar Chart)
        const ctxTopProducts = document.getElementById('topProductsChart').getContext('2d');
        new Chart(ctxTopProducts, {
            type: 'bar',
            data: {
                labels: chartData.top_product_names,
                datasets: [{
                    label: 'Quantity Sold',
                    data: chartData.top_product_quantities,
                    backgroundColor: '#6C63FF', /* Primary color */
                    borderColor: '#8D86FF', /* Accent color for border */
                    borderWidth: 1,
                    borderRadius: 5 /* Rounded bars */
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', /* Horizontal bars */
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Quantity Sold', color: '#555' },
                        grid: { color: 'rgba(0,0,0,0.08)', drawBorder: false },
                        ticks: { color: '#555' }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#555' }
                    }
                },
                plugins: {
                    legend: { display: false }, /* No legend needed for single bar dataset */
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += context.parsed.x.toLocaleString();
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
<script id="chart-data" type="application/json">
    {{ chart_data|json_script:"chart_data" }}
</script>
{% endblock %}
