{% extends 'base.html' %}
{% load static %}

{% block title %}Payment{% endblock %}

{% block content %}
<section class="billing_details_area p-5">
    <div class="container">
        {% if error %}
            <div class="alert alert-danger text-center">
                {{ error }}
            </div>
        {% else %}
        <div class="row">
            <!-- Billing Information -->
            <div class="col-lg-7">
                <h3 class="mb-4">ðŸ§¾ Billing Details</h3>
                <div class="card shadow-sm p-4 rounded-4">
                    <div class="row">
                        <div class="col-md-6 mb-3"><strong>First Name:</strong> {{ bill_address.first_name }}</div>
                        <div class="col-md-6 mb-3"><strong>Last Name:</strong> {{ bill_address.last_name }}</div>
                        <div class="col-md-12 mb-3"><strong>Address:</strong> {{ bill_address.address }}</div>
                        <div class="col-md-6 mb-3"><strong>City:</strong> {{ bill_address.city }}</div>
                        <div class="col-md-6 mb-3"><strong>Country:</strong> {{ bill_address.country.name }}</div>
                        <div class="col-md-6 mb-3"><strong>Zip Code:</strong> {{ bill_address.zipcode }}</div>
                        <div class="col-md-6 mb-3"><strong>Phone:</strong> {{ bill_address.phone }}</div>
                        <div class="col-md-12 mb-3"><strong>Email:</strong> {{ bill_address.email }}</div>
                    </div>
                </div>
            </div>

            <!-- Order Summary + Payment -->
            <div class="col-lg-5">
                <h3 class="mb-4">ðŸ›’ Your Order</h3>
                <div class="card shadow-sm p-4 rounded-4">
                    {% for item in orders.order_items.all %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ item.product.name }} x {{ item.quantity }}</span>
                            <span>â‚¦{{ item.get_final_price|floatformat:2 }}</span>
                        </div>
                    {% endfor %}
                    <hr>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Subtotal:</span>
                        <span>â‚¦{{ orders.get_total_price|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Shipping:</span>
                        <span>â‚¦{{ shipping|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Tax:</span>
                        <span>â‚¦{{ tax|floatformat:2 }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <strong>Total:</strong>
                        <strong>â‚¦{{ grand_total|floatformat:2 }}</strong>
                    </div>

                    <!-- Payment Method -->
                    <h5 class="mt-4">ðŸ’³ Choose Payment Method</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="paystack_option" value="paystack" checked>
                        <label class="form-check-label" for="paystack_option">Pay with Paystack</label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="payment_method" id="card_option" value="card">
                        <label class="form-check-label" for="card_option">Pay with Card</label>
                    </div>

                    <button class="btn btn-primary w-100 mt-3" onclick="submitPayment()">Proceed to Pay</button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Paystack JS -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
function submitPayment() {
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    const email = "{{ bill_address.email|escapejs }}";
    const amount = Math.round(parseFloat("{{ grand_total|floatformat:'2' }}") * 100);  // In kobo
    const ref = "{{ unique_ref|escapejs }}";

    if (paymentMethod === "paystack") {
        let handler = PaystackPop.setup({
            key: "{{ paystack_public_key|escapejs }}",
            email: email,
            amount: amount,
            currency: "NGN",
            ref: ref,
            callback: function(response) {
                window.location.href = "{% url 'verifyPayment' %}?reference=" + response.reference;
            },
            onClose: function() {
                alert("Payment cancelled.");
            }
        });
        handler.openIframe();
    } else {
        alert("ðŸ’³ Card gateway coming soon. Using Paystack for now.");
    }
}
</script>
{% endblock %}
