{% extends "base.html" %}
{% load static %}

{% block title %}Home | EcomStore{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section text-white rounded-4 shadow-lg mb-5">
    <div class="container text-center">
        <h1>Discover Our Latest Collection</h1>
        <p class="lead mb-4">
            Explore a wide range of products crafted with quality and care. Find what you love!
        </p>
        <a href="{% url 'products_list' %}" class="btn btn-light btn-lg rounded-pill shadow-sm px-4 py-2">
            Shop Now <i class="fas fa-arrow-right ms-2"></i>
        </a>
    </div>
</section>

<!-- Featured Products Section -->
<section class="py-section">
    <h2 class="text-center mb-5 display-5 fw-bold">Featured Products</h2>

    {% if featured_products %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for product in featured_products %}
        <div class="col">
            <div class="card h-100">
                <a href="{{ product.get_absolute_url }}">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}"
                             onerror="this.onerror=null;this.src='{% static 'img/image_unavailable.png' %}';">
                    {% else %}
                        <img src="{% static 'img/image_unavailable.png' %}" class="card-img-top" alt="Image unavailable">
                    {% endif %}
                </a>

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text text-muted small">
                        {{ product.description|default:"No description."|truncatechars:100 }}
                    </p>

                    <div class="d-flex justify-content-between align-items-center mt-auto pt-3">
                        <span class="product-price">
                            {% if product.discount_price and product.discount_price < product.price %}
                                <del class="text-muted small">₦{{ product.price }}</del>
                                <span class="ms-1">₦{{ product.discount_price }}</span>
                            {% else %}
                                ₦{{ product.price }}
                            {% endif %}
                        </span>

                        <button class="btn btn-primary btn-sm rounded-pill add-to-cart-btn"
                                data-product-id="{{ product.id }}"
                                data-product-name="{{ product.name }}">
                            <i class="fas fa-shopping-cart me-2"></i> Add
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
        <p class="text-center">No featured products at the moment. Check back soon!</p>
    {% endif %}
</section>

<!-- Call-to-Action Section -->
<section class="py-section bg-white rounded-4 shadow-lg text-center my-section">
    <div class="container">
        <h2 class="display-5 fw-bold mb-4">Ready to find your next favorite item?</h2>
        <p class="lead mb-5">
            Browse our full catalog and discover amazing deals and new arrivals every day.
        </p>
        <a href="{% url 'products_list' %}" class="btn btn-outline-primary btn-lg rounded-pill shadow-sm px-5 py-3">
            View All Products <i class="fas fa-arrow-alt-circle-right ms-2"></i>
        </a>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function showAjaxMessage(msg, type = 'success') {
    const box = document.getElementById('ajax-message-box');
    box.textContent = msg;
    box.style.backgroundColor = type === 'success'
        ? 'rgba(40,167,69,0.9)'
        : 'rgba(220,53,69,0.9)';
    box.style.display = 'block';
    setTimeout(() => box.style.display = 'none', 3000);
}

document.addEventListener('DOMContentLoaded', () => {
    const csrftoken = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];

    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            fetch("{% url 'api_add_to_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    product_id: btn.dataset.productId,
                    quantity: 1
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAjaxMessage(`'${btn.dataset.productName}' added to cart!`);

                    // Update cart count in navbar badge
                    const cartBadge = document.querySelector('.fa-shopping-cart + .badge');
                    if (cartBadge) {
                        cartBadge.textContent = data.cart_count;
                        cartBadge.classList.remove('d-none');
                    }

                    // Optional: Redirect to cart page after add
                    // window.location.href = "{% url 'cart' %}";
                } else {
                    showAjaxMessage(data.message || 'Could not add to cart', 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showAjaxMessage('Error adding to cart', 'error');
            });
        });
    });
});
</script>
{% endblock %}
